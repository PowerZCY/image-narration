# Stripe 支付与积分系统测试计划

## 概述

本测试计划涵盖 Stripe 支付集成、积分系统、Webhook 处理等核心功能的完整测试验证。

## 测试环境

- **Next.js**: 15.3.2
- **Supabase**: 本地开发环境
- **Stripe**: 测试环境
- **测试框架**: Jest
- **数据库**: PostgreSQL (Supabase)

## 测试分类

### TC-DB: 数据库迁移测试 (3个用例)

#### TC-DB-001: 表结构验证
- 验证所有必要表已创建
- 检查表字段类型和约束
- 验证索引创建

#### TC-DB-002: 外键约束测试
- 验证表间关系正确性
- 测试级联删除机制
- 检查数据完整性约束

#### TC-DB-003: 触发器功能测试
- 验证 updated_at 自动更新
- 测试数据变更触发器
- 检查约束触发器

### TC-ANON: 匿名用户功能测试 (12个用例)

#### TC-ANON-001: 匿名ID生成测试
- 相同IP生成相同ID
- 不同IP生成不同ID
- 缺少IP返回null
- IPv6地址处理

#### TC-ANON-002: 免费试用额度测试
- 首次使用消费积分成功
- 免费试用用尽后拒绝服务
- 积分记录正确性

#### TC-ANON-003: 速率限制测试
- 正常频率请求通过
- 超频请求被限制
- 限制重置机制

#### TC-ANON-004: HMAC安全测试
- 验证ID生成的安全性
- 防篡改机制测试
- 格式验证（43位base64url）

### TC-USER: 用户认证和积分系统测试 (12个用例)

#### TC-USER-001: 用户初始化测试
- ensureUser 新用户创建
- 重复调用幂等性
- 用户数据完整性

#### TC-USER-002: 积分消费功能测试
- 余额充足时成功扣减
- 余额不足时拒绝服务
- 消费记录准确性

#### TC-USER-003: 积分退款机制测试
- 待确认消费可退款
- 已确认消费拒绝退款
- 退款记录正确性

#### TC-USER-004: 积分充值功能测试
- 正确增加积分余额
- 有效期延长机制
- 充值记录完整性

#### TC-USER-005: 积分有效期检查
- 过期积分检测
- 未过期积分正常使用
- 自动过期处理

### TC-PAY: 支付流程测试 (12个用例)

#### TC-PAY-001: Checkout Session创建
- 成功创建支付会话
- 订单记录生成
- 价格配置正确性

#### TC-PAY-002: 支付成功处理
- Webhook正确处理支付成功
- 积分正确发放
- 订单状态更新

#### TC-PAY-003: 未登录支付拦截
- 未认证用户请求被拒绝
- 错误信息合适
- 安全性验证

#### TC-PAY-004: 价格套餐验证
- Starter套餐配置
- Pro套餐配置
- Elite套餐配置

#### TC-PAY-005: 连续购买有效期处理
- 多次购买有效期累加
- 最大有效期限制
- 积分余额正确累计

#### TC-PAY-006: 支付金额不匹配检测
- 检测金额篡改
- 安全拒绝处理
- 订单状态标记

#### TC-PAY-007: 货币不匹配检测
- 检测货币类型篡改
- 多币种支持验证
- 汇率处理机制

#### TC-PAY-008: 支付状态验证
- 未完成支付拒绝
- 已完成支付接受
- 状态转换逻辑

#### TC-PAY-009: 完整支付流程验证
- 端到端支付测试
- 用户体验验证
- 数据一致性检查

### TC-WEBHOOK: Webhook处理测试 (8个用例)

#### TC-WEBHOOK-001: 签名验证
- 拒绝无签名请求
- 拒绝错误签名请求
- 接受有效签名请求

#### TC-WEBHOOK-002: 幂等性保证
- 重复事件不重复处理
- 积分不重复发放
- 事件记录去重

#### TC-WEBHOOK-003: 事件时效性
- 接受5分钟内事件
- 拒绝过期事件
- 时间窗口验证

#### TC-WEBHOOK-004: 订单状态更新
- pending到paid状态转换
- 完整元数据记录
- 时间戳管理

### TC-SEC: 安全和风控测试 (16个用例)

#### TC-SEC-001: SQL注入防护
- 用户查询注入防护
- 积分操作注入防护
- 参数化查询验证

#### TC-SEC-002: XSS防护
- 显示名称清理
- API响应安全处理
- HTML转义机制

#### TC-SEC-003: 认证授权
- 保护接口认证要求
- 用户数据访问控制
- Token真实性验证

#### TC-SEC-004: 速率限制
- 快速请求处理
- 限流头部信息
- 重试机制

#### TC-SEC-005: 敏感信息保护
- 内部ID隐藏
- 错误信息清理
- 配置信息保护
- Webhook签名验证安全

### TC-PERF: 性能和并发测试 (11个用例)

#### TC-PERF-001: 并发扣减测试
- 防止超售机制
- 不同金额并发消费
- 数据一致性保证

#### TC-PERF-002: 并发充值测试
- 多重充值正确处理
- 高并发一致性维护
- 性能指标检查

#### TC-PERF-003: 事务超时处理
- 超时优雅处理
- 失败回滚机制
- 事务完整性

#### TC-PERF-004: 负载测试
- 中等负载性能维护
- 内存使用效率
- 数据库连接池效率
- 批量操作处理
- 查询性能优化

## 预期结果

- **数据库测试**: 100% 通过，确保结构完整性
- **业务逻辑测试**: 95%+ 通过率，核心功能可靠
- **安全测试**: 重要安全机制验证通过
- **性能测试**: 满足预期性能指标

## 风险和缓解

### 高风险
- **数据一致性**: 通过事务和约束保证
- **支付安全**: 多重验证和签名检查
- **并发控制**: 数据库锁和幂等性机制

### 中风险
- **性能瓶颈**: 监控和优化查询性能
- **错误处理**: 完善异常处理和用户提示

## 测试数据

- **测试用户**: 3个标准测试账户
- **支付金额**: $2.00, $5.00, $10.00 (Starter, Pro, Elite)
- **积分配额**: 10, 40, 100 credits
- **测试IP**: 192.168.1.100, 10.0.0.1等

## 执行计划

1. **阶段1**: 数据库和基础功能测试
2. **阶段2**: 支付流程和Webhook测试
3. **阶段3**: 安全和性能测试
4. **阶段4**: 综合集成测试

## 成功标准

- 所有关键业务路径通过测试
- 安全机制有效防护
- 性能指标满足要求
- 数据完整性得到保证
- 错误处理机制完善

---

*文档版本: v1.0*  
*创建时间: 2025-09-23*  
*适用环境: Development + Staging*